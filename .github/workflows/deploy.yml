name: Deployment Workflow

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy_production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: Production
      url: https://gjovanovicst.github.io/deploy-site-production
    steps:
      - name: Checkout Main Project
        uses: actions/checkout@v2
        with:
          path: ./deploy-site

      - name: Checkout Production Project
        uses: actions/checkout@master
        with:
          repository: gjovanovicst/deploy-site-production
          token: ${{ secrets.ACCESS_TOKEN }}
          path: ./deploy-site-production

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install

      - name: Build Code
        run: npm run build

      - name: Copy/Create file
        run: |
          FILES=./deploy-site/www
          if [ -d "$FILES" ]; then
            echo "Copying $FILES"
            cp -R ./deploy-site/www/* ./deploy-site-production
          else 
            echo "There is no www folder. Make sure that you build site."
          fi
      - name: Push Deployment Production project
        run: |
          cd ./deploy-site-production
          git add .
          git config user.name gjovanovicst
          git config user.email gjovanovic.st@gmail.com
          git commit -am "File Replicated from deploy-site"
          git push

  deploy_preview:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: Preview
      url: https://gjovanovicst.github.io/deploy-site-preview
    steps:
      - name: Checkout Main Project
        uses: actions/checkout@v2
        with:
          path: ./deploy-site

      - name: Checkout Preview Project
        uses: actions/checkout@master
        with:
          repository: gjovanovicst/deploy-site-preview
          token: ${{ secrets.ACCESS_TOKEN }}
          path: ./deploy-site-preview

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install

      - name: Build Code
        run: npm run build

      - name: Copy/Create file
        run: |
          FILES=./deploy-site/www
          if [ -d "$FILES" ]; then
            echo "Copying $FILES"
            cp -R ./deploy-site/www/* ./deploy-site-preview
          else 
            echo "There is no www folder. Make sure that you build site."
          fi
      - name: Push Deployment Preview project
        run: |
          cd ./deploy-site-preview
          git add .
          git config user.name gjovanovicst
          git config user.email gjovanovic.st@gmail.com
          git commit -am "File Replicated from deploy-site"
          git push
    # steps:
    #      - name: Pushes to another repository
    #        id: push_directory
    #        uses: cpina/github-action-push-to-another-repository@main
    #        env:
    #          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
    #        with:
    #         source-directory: /
    #         destination-github-username: 'gjovanovicst'
    #         destination-repository-name: 'deploy-site-production'
    #         user-email: gjovanovic.st@gmail.com
    #         commit-message: See ORIGIN_COMMIT from $GITHUB_REF
    #         target-branch: main

#       - name: Push generated webpage to another repository production
#         uses: nkoppel/push-files-to-another-repository@v1.1.0
#         env:
#           API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
#         with:
#           source-files: '.'
#           destination-username: 'gjovanovicst'
#           destination-repository: 'deploy-site-production'
#           destination-directory: 'deploy-site-production'
#           commit-email: 'gjovanovic.st@gmail.com'

#   deploy_preview:
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/develop'
#     steps:
#     - name: Push generated webpage to another repository preview
#       uses: nkoppel/push-files-to-another-repository@v1.1.0
#       env:
#         API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
#       with:
#         source-files: 'webpage/'
#         destination-username: 'gjovanovicst'
#         destination-repository: 'deploy-site-preview'
#         destination-directory: 'deploy-site-preview'
#         commit-email: 'gjovanovic.st@gmail.com'
